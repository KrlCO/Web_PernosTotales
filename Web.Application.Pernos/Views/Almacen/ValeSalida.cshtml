
    <div class="container mt-5">
        <!-- Encabezado -->
        <h2 class="text-center mb-4">VALE SALIDA / ENTRADA</h2>

        <!-- Botones -->
        <div class="d-flex justify-content-center mb-4">
        <button id="btnGuardar" class="btn btn-primary mx-2">Guardar</button>
            <button id="btnCancelar" class="btn btn-danger mx-2">Cancelar</button>
            <button class="btn btn-info mx-2">Imprimir</button>
        </div>

        <!-- Filas de Inputs -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="tipo" class="form-label">Tipo</label>
            <select id="tipo" class="form-select">
                    <option value="">Seleccionar Tipo</option>
                    <option value="S">Salida</option>
                    <option value="E">Entrada</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="almacen" class="form-label">Almacén</label>
                <select id="almacen" class="form-select">
                    <option>Seleccionar Almacén</option>

                </select>
            </div>
            <div class="col-md-6">
                <label for="tipoMovimiento" class="form-label">Tipo Movimiento</label>
                <select id="tipoMovimiento" class="form-select">
                    <option>Seleccionar Tipo Movimiento</option>
                    <!-- Opciones se llenarán dinámicamente -->
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-3">
                <label for="numeroVale" class="form-label">Código Vale</label>
                <input type="text" id="numeroVale" class="form-control">
            </div>
           @*  <div class="col-md-3">
                <label for="numeroParte" class="form-label">N° Parte Salida</label>
                <input type="text" id="numeroParte" class="form-control">
            </div> *@
            <div class="col-md-3">
                <label for="fecha" class="form-label">Fecha</label>
                <input type="date" id="fecha" class="form-control">
            </div>
        </div>

        <!-- Dentro del formulario -->
        <input type="hidden" id="tipo" name="tipo" />
        <input type="hidden" id="almacen" name="almacen" />
        <input type="hidden" id="tipoMovimiento" name="tipoMovimiento" />
        <input type="hidden" id="fecha" name="fecha" />

        <!-- Botón Agregar Detalle -->
        <div class="d-flex justify-content-start mb-4">
            <button class="btn btn-success">Agregar Detalle</button>
        </div>

        <!-- Tabla de Detalles -->
        <div class="table-responsive">
            <table id="valesTable" class="table table-bordered">
                <thead class="table-light text-center">
                    <tr>
                        @* <th>N°</th> *@
                        <th>Código Producto</th>
                        <th>Nombre</th>
                        <th>Categoria</th>
                        <th>Unidad Medida</th>
                        <th>Cantidad</th>
                        <th>Precio Compra</th>
                        <th>Importe</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>

        <!-- Textboxes de SUB-TOTAL, I.G.V. y TOTAL -->
        <div class="row">
            <div class="col-md-2 offset-md-9">
                <div class="mb-2">
                    <label for="subTotal" class="form-label">SUB-TOTAL</label>
                    <input type="text" id="subTotal" class="form-control" readonly>
                </div>
                <div class="mb-2">
                    <label for="igv" class="form-label">I.G.V. (18%)</label>
                    <input type="text" id="igv" class="form-control" readonly>
                </div>
                <div class="mb-2">
                    <label for="total" class="form-label">TOTAL</label>
                    <input type="text" id="total" class="form-control" readonly>
                </div>
            </div>
        </div>

        <!-- Modal Agregar Detalle -->
        <div class="modal fade" id="modalAgregarDetalle" tabindex="-1" aria-labelledby="modalAgregarDetalleLabel" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarDetalleLabel">Agregar Detalle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Input para ingresar la cantidad de productos -->
                        <div class="mb-2">
                            <label for="cantidadProductos" class="form-label">Cantidad de Productos a Agregar:</label>
                            <input type="number" id="cantidadProductos" class="form-control form-control-sm" value="" min="1">
                        </div>

                        <!-- DataTable -->
                        <div class="table-responsive">
                            <table id="productosTable" class="table table-bordered table-striped w-100">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th>Código Producto</th>
                                        <th>Nombre</th>
                                        <th>Categoría</th>
                                        <th>Unidad Medida</th>
                                        <th>Stock</th>
                                        <th>Precio Compra</th>
                                        <th>Estado</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                 
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">

                    </div>
                </div>
            </div>
        </div>
    </div>
@section Scripts {

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.0/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.11.0/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

    <script>

        $('#tipo').change(function () {
            var tipoSeleccionado = $(this).val();
            $('input[name="tipo"]').val(tipoSeleccionado);
        });

        $('#almacen').change(function () {
            var almacenSeleccionado = $(this).val();
            $('input[name="almacen"]').val(almacenSeleccionado);
        });

        $('#tipoMovimiento').change(function () {
            var tipoMovimientoSeleccionado = $(this).val();
            $('input[name="tipoMovimiento"]').val(tipoMovimientoSeleccionado);
        });

        $('#fecha').change(function () {
            var fechaSeleccionada = $(this).val();
            $('input[name="fecha"]').val(fechaSeleccionada);
        });


        $(document).ready(function () {
            $('#tipo').change(function () {
                var tipoSeleccionado = $(this).val();

                if (tipoSeleccionado) {
                    $.ajax({
                        url: '@Url.Action("ObtenerTiposMovimiento", "Almacen")',
                        type: 'GET',
                        data: { tipo: tipoSeleccionado },
                        success: function (data) {
                            var $tipoMovimiento = $('#tipoMovimiento');
                            $tipoMovimiento.empty();
                            $tipoMovimiento.append('<option>Seleccionar Tipo Movimiento</option>');

                            if (data.error) {
                                console.error('Error en el servidor:', data.error);
                                return;
                            }

                            $.each(data, function (index, item) {
                                $tipoMovimiento.append('<option value="' + item.idTipoMovimiento + '">' + item.tipoMovimiento + '</option>');
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error('Error al obtener los tipos de movimiento:', error);
                        }
                    });
                } else {
                    $('#tipoMovimiento').empty().append('<option>Seleccionar Tipo Movimiento</option>');
                }
            });

            $('#btnCancelar').on('click', function () {
                window.location.href = '@Url.Action("Vales", "Almacen")';
            });
        });

        $(document).ready(function () {
            cargarAlmacenes();

            // Función para cargar los almacenes en el combobox
            function cargarAlmacenes() {
                $.ajax({
                    url: '@Url.Action("ObtenerAlmacenes", "Almacen")',
                    type: 'GET',
                    success: function (data) {
                        var $almacen = $('#almacen');
                        $almacen.empty();
                        $almacen.append('<option value="">Seleccionar Almacén</option>');

                        if (data.error) {
                            console.error('Error en el servidor:', data.error);
                            return;
                        }

                        $.each(data, function (index, item) {
                            $almacen.append('<option value="' + item.idAlmacen + '">' + item.nombreAlmacen + '</option>');
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error al obtener los almacenes:', error);
                    }
                });
            }
        });

        //Scripts MODAL
        $(document).ready(function () {
            // Modal "Agregar Detalle"
            $('.btn-success').on('click', function () {
                $('#modalAgregarDetalle').modal('show');
            });

            // Manejar la cantidad mínima del input
            $('#cantidadProductos').on('input', function () {
                if ($(this).val() < 1) {
                    $(this).val(1); // Establece la cantidad mínima en 1
                }
            });

            // Cargar datos en el DataTable al abrir el modal
            $('#modalAgregarDetalle').on('show.bs.modal', function () {
                cargarProductos();
            });

            function cargarProductos() {
                // Llamada AJAX para obtener los productos
                $.ajax({
                    url: '@Url.Action("ObtenerProductos", "Almacen")',
                    type: 'GET',
                    success: function (data) {
                        var $tableBody = $('#productosTable tbody');
                        $tableBody.empty();

                        $.each(data, function (index, producto) {
                            var fila = `
                                    <tr>
                                        <td>${producto.idProducto}</td>
                                        <td>${producto.nombre}</td>
                                        <td>${producto.categoriaNombre}</td>
                                        <td>${producto.unidadMedidaNombre}</td>
                                        <td>${producto.stock}</td>
                                        <td>${producto.precioCompra}</td>
                                        <td>${producto.estado}</td>
                                        <td class="text-center">
                                            <button class="btn btn-primary btn-seleccionar" data-id="${producto.idProducto}" data-nombre="${producto.nombre}" data-categoria="${producto.categoriaNombre}" data-unidad="${producto.unidadMedidaNombre}" data-precio="${producto.precioCompra}">
                                                Seleccionar
                                            </button>
                                        </td>
                                    </tr>`;
                            $tableBody.append(fila);
                        });

                        // Inicializar el DataTable con paginación personalizada
                        $('#productosTable').DataTable({
                            destroy: true, // Permitir reinicialización del DataTable
                            responsive: true,
                            paging: true,
                            pageLength: 10, // Mostrar 10 productos por página
                            language: {
                                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json'
                            },
                            layout: {
                                bottomEnd: {
                                    paging: {
                                        firstLast: false // Ocultar botones "Primero" y "Último"
                                    }
                                }
                            }
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error al cargar los productos:', error);
                    }
                });
            }
            // Función para agregar producto al detalle
            function agregarDetalleProducto(productoId, nombre, categoria, unidad, cantidad, precioCompra) {
                var $tableBody = $('#valesTable tbody');
                var importe = (precioCompra * cantidad).toFixed(2); // Calcula el importe (precioCompra * cantidad)

                var fila = `
                                <tr>
                                    <td>${productoId}</td>
                                    <td>${nombre}</td>
                                    <td>${categoria}</td>
                                    <td>${unidad}</td>
                                    <td>${cantidad}</td>
                                    <td>${precioCompra}</td>
                                    <td>${importe}</td>
                                    <td><button type="button" class="btn btn-sm btn-danger eliminar-detalle"><i class="fas fa-trash-alt"></i></button></td>
                                </tr>`;

                $tableBody.append(fila);
            }

            // Manejar el botón "Seleccionar"
            $(document).on('click', '.btn-seleccionar', function () {
                var productoId = $(this).data('id');
                var nombre = $(this).data('nombre');
                var categoria = $(this).data('categoria');
                var unidad = $(this).data('unidad');
                var precioCompra = $(this).data('precio');
                var cantidad = parseInt($('#cantidadProductos').val());

                if (cantidad >= 1) {
                    agregarDetalleProducto(productoId, nombre, categoria, unidad, cantidad, precioCompra);
                    $('#modalAgregarDetalle').modal('hide');
                } else {
                    alert('La cantidad de productos debe ser al menos 1.');
                }
            });

            $(document).on('click', '.eliminar-detalle', function () {
                $(this).closest('tr').remove();
            });
        });



        $(document).ready(function () {
            // Guardar compra o vale de salida
            $('.btn-primary').on('click', function () {
                // Asignar los valores a los campos ocultos
                $('#tipo').val($('#tipo').val());
                $('#almacen').val($('#almacen').val());
                $('#tipoMovimiento').val($('#tipoMovimiento').val());
                $('#fecha').val($('#fecha').val());

                // Recolectar los detalles de la tabla
                var detalles = [];
                $('#valesTable tbody tr').each(function () {
                    var row = $(this);
                    var detalle = {
                        IdProducto: row.find('td:eq(0)').text(),
                        Cantidad: row.find('td:eq(4)').text(),
                        Precio: row.find('td:eq(5)').text()
                    };
                    detalles.push(detalle);
                });

                var tipoOperacion = $('#tipo').val();

                if (tipoOperacion === 'E') {
                    // Preparar el objeto para registrar la compra
                    var compraDTO = {
                        IdAlmacen: $('#almacen').val(),
                        IdTipoMovimiento: $('#tipoMovimiento').val(),
                        detalleCompra: detalles
                    };

                    $.ajax({
                        url: '@Url.Action("RegistrarCompra", "Almacen")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(compraDTO),
                        success: function (data) {
                            if (data.success) {
                                alert('Entrada registrada exitosamente');
                                window.location.href = '@Url.Action("Vales", "Almacen")';
                            } else {
                                alert('Error: ' + data.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error al registrar la compra:', error);
                        }
                    });

                } else if (tipoOperacion === 'S') {
                    // Preparar el objeto para registrar el vale de salida
                    var ventaDTO = {
                        IdAlmacen: $('#almacen').val(),
                        IdTipoMovimiento: $('#tipoMovimiento').val(),
                        // FechaOperacion: $('#fecha').val(),
                        // Tipo: tipoOperacion,
                        detalleSalida: detalles
                    };

                    $.ajax({
                        url: '@Url.Action("RegistrarValeSalida", "Almacen")',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(ventaDTO),
                        success: function (data) {
                            if (data.success) {
                                alert('Vale de salida registrado exitosamente');
                                window.location.href = '@Url.Action("Vales", "Almacen")';
                            } else {
                                alert('Error: ' + data.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error al registrar el vale de salida:', error);
                        }
                    });

                } else {
                    alert('Por favor, seleccione un tipo de operación válido ("ENTRADA" o "SALIDA").');
                }
            });
        });

        //Script para calcular SUB - TOTAL, I.G.V.y TOTAL
            function calcularTotales() {
                let subTotal = 0;
                $('#valesTable tbody tr').each(function () {
                    const importe = parseFloat($(this).find('td:eq(6)').text());
                    if (!isNaN(importe)) {
                        subTotal += importe;
                    }
                });

                const igv = subTotal * 0.18;
                const total = subTotal + igv;

                $('#subTotal').val(subTotal.toFixed(2));
                $('#igv').val(igv.toFixed(2));
                $('#total').val(total.toFixed(2));
            }

        // Llamar a la función cada vez que se agregue o elimine una fila
        $(document).on('click', '.btn-seleccionar', function () {
            setTimeout(calcularTotales, 500);
        });

        $(document).on('click', '.eliminar-detalle', function () {
            $(this).closest('tr').remove();
            calcularTotales();
        });

    </script>
}
